package bots.rulebasedbot;

import com.biotools.meerkat.Action;
import com.biotools.meerkat.Card;
import com.biotools.meerkat.GameInfo;
import com.biotools.meerkat.Player;
import com.biotools.meerkat.util.Preferences;
import org.drools.core.ClassObjectFilter;
import org.drools.core.base.RuleNameEndsWithAgendaFilter;
import org.kie.api.KieServices;
import org.kie.api.runtime.KieContainer;
import org.kie.api.runtime.KieSession;
import org.kie.api.runtime.rule.FactHandle;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Collection;

public class RuleBasedBot implements Player {

    private int ourSeat; // our seat for the current hand
    private Card c1, c2; // our hole cards
    private GameInfo gi; // general game information
    private Preferences prefs; // the configuration options for this bot
    private PlayStyle playStyle;
    private Boolean semiBluffingFlag;

    private KieServices ks;
    private KieContainer kContainer;
    private KieSession kSession;

    public RuleBasedBot() throws IOException {
        byte[] encoded = Files.readAllBytes(Paths.get("data/bots/RuleBasedBot.pd"));
        String[] values = new String(encoded).split("=");
        String sessionName = values[values.length - 1].trim();
        ks = KieServices.Factory.get();
        kContainer = ks.getKieClasspathContainer();
        kSession = kContainer.newKieSession("ksession-" + sessionName);
        BettingEvent be1 = new BettingEvent(HandStrengthEnum.THIRTY_TO_FORTY, false);
        BettingEvent be2 = new BettingEvent(HandStrengthEnum.FORTY_TO_FIFTY, false);
        BettingEvent be3 = new BettingEvent(HandStrengthEnum.FIFTY_TO_SIXTY, false);
        kSession.insert(be1);
        kSession.insert(be2);
        kSession.insert(be3);
        playStyle = PlayStyle.MODERATE;
        semiBluffingFlag = false;
    }

    @Override
    public void init(Preferences preferences) {
        this.prefs = preferences;
    }

    @Override
    public void holeCards(Card c1, Card c2, int seat) {
        this.c1 = c1;
        this.c2 = c2;
        this.ourSeat = seat;
    }

    public Preferences getPreferences() {
        return prefs;
    }

    @Override
    public Action getAction() {
        if (gi.isPreFlop()) {
            setPreFlopGlobals();
            boolean smallBlind = gi.getSmallBlindSeat() == ourSeat;
            int factor;
            if (smallBlind || gi.getBigBlindSeat() == ourSeat) {
                factor = gi.getNumToAct() - 1;
            } else {
                factor = gi.getNumToAct() - 2;
            }
            int num_guaranteed = gi.getNumActivePlayers() - factor;
            int expectedNumOfPlayers = (int) Math
                    .round(num_guaranteed + 0.6 * (gi.getNumActivePlayers() - num_guaranteed));
            System.out.println("Active players: " + gi.getNumActivePlayers());
            System.out.println("To act: " + gi.getNumToAct());
            System.out.println("Expected players: " + expectedNumOfPlayers);
            PlayerState ps = new PlayerState(c1, c2, ourSeat, expectedNumOfPlayers, false, -500,
                    Strategy.NO_STRATEGY, smallBlind, playStyle, null);
            kSession.insert(ps);

            kSession.fireAllRules(new RuleNameEndsWithAgendaFilter("pre-flop"));

            kSession.getAgenda().getAgendaGroup("backward").setFocus();
            kSession.fireAllRules();
            kSession.getAgenda().getAgendaGroup("MAIN").setFocus();

            removePlayerStateFromSession(ps);

            System.out.println(ps.getCard1());
            System.out.println(ps.getCard2());
            System.out.println(ps.getIR());
            return ps.getActionToTake();
        } else {
            setPostFlopGlobals();
            PlayerState ps = new PlayerState(c1, c2, ourSeat, 0, false, -500,
                    Strategy.NO_STRATEGY, false, playStyle, null);
            kSession.insert(ps);

            kSession.fireAllRules(new RuleNameEndsWithAgendaFilter("post-flop"));

            kSession.getAgenda().getAgendaGroup("backward").setFocus();
            kSession.fireAllRules();
            kSession.getAgenda().getAgendaGroup("MAIN").setFocus();

            removePlayerStateFromSession(ps);

            semiBluffingFlag = (Boolean) kSession.getGlobal("semiBluffingFlag");
            return ps.getActionToTake();
        }
    }

    private void removePlayerStateFromSession(PlayerState ps) {
        FactHandle fh = kSession.getFactHandle(ps);
        kSession.delete(fh);
    }

    private void setPreFlopGlobals() {
        kSession.setGlobal("make1Threshold", 0);
        kSession.setGlobal("make2Threshold", 0);
        kSession.setGlobal("make4Threshold", 0);
        kSession.setGlobal("call1Threshold", 0);
        kSession.setGlobal("call2Threshold", 0);
        kSession.setGlobal("numOfPlayersToAct", gi.getSmallBlindSeat() >= ourSeat ? gi
                .getSmallBlindSeat() - ourSeat : gi.getNumToAct() + gi.getSmallBlindSeat() - 1);
        kSession.setGlobal("gameInfo", gi);
        kSession.setGlobal("phase", 1);
    }

    private void setPostFlopGlobals() {
        kSession.setGlobal("make1PostFlopThreshold", 0.5);
        kSession.setGlobal("make2PostFlopThreshold", 0.85);
        kSession.setGlobal("potOdds", 0.0);
        kSession.setGlobal("potOdds2", 0.0);
        kSession.setGlobal("showdownCost", 0.0);
        kSession.setGlobal("showdownOdds", 0.0);
        kSession.setGlobal("semiBluffingFlag", semiBluffingFlag);
        kSession.setGlobal("gameInfo", gi);
        kSession.setGlobal("phase", -1);
    }

    @Override
    public void actionEvent(int i, Action action) {
        System.out.println("********** Action **********");
        System.out.println("Action seat: " + i);
        System.out.println("Action: " + action.toString());
        System.out.println("********************");
    }

    @Override
    public void stageEvent(int i) {
    }

    @Override
    public void showdownEvent(int i, Card card, Card card1) {
        System.out.println("********** SHOWDOWN **********");
        System.out.println("Seat: " + i);
        System.out.println("Card1: " + card);
        System.out.println("Card2: " + card1);
        System.out.println("********************");
    }

    @Override
    public void gameStartEvent(GameInfo gameInfo) {
        this.gi = gameInfo;
    }

    @Override
    public void dealHoleCardsEvent() {
    }

    @Override
    public void gameOverEvent() {

    }

    @Override
    public void winEvent(int i, double v, String s) {
        System.out.println("********** WIN **********");
        System.out.println("Seat: " + i);
        System.out.println("Amount: " + v);
        System.out.println("Result: " + s);
        System.out.println("********************");
    }

    @Override
    public void gameStateChanged() {
    }

    public boolean getDebug() {
        return prefs.getBooleanPreference("DEBUG", false);
    }

    public void debug(String str) {
        if (getDebug()) {
            System.out.println(str);
        }
    }
}
