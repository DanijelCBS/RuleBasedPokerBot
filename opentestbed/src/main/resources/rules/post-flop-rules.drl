package rules

import com.biotools.meerkat.Card;
import com.biotools.meerkat.Action;
import com.biotools.meerkat.GameInfo;
import bots.rulebasedbot.Utility;
import bots.rulebasedbot.Utility.EnumerateResult;
import bots.rulebasedbot.PlayerState;
import bots.rulebasedbot.PlayStyle;
import bots.rulebasedbot.Strategy;
import com.biotools.meerkat.Holdem;

global Integer make2Threshold;
global Integer make4Threshold;
global Double potOdds;
global Double potOdds2;
global Boolean semiBluffingFlag;
global Double showdownCost;
global Double showdownOdds;
global GameInfo gameInfo;


rule "Calculate potentials and hand rank"
    when
        $ps: PlayerState($card1: card1, $card2: card2)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setResults(Utility.enumerateHands($card1, $card2, gameInfo))
        }
end

rule "Reset semi-bluffing flag"
    when
        $ps: PlayerState($card1: card1, $card2: card2, (gameInfo.getStage() == Holdem.FLOP || gameInfo.getBetsToCall() > 0))
    then
        System.out.println("Rule: " + drools.getRule().getName());
        drools.getKnowledgeRuntime().setGlobal("semiBluffingFlag", false);
end

rule "Strategy MAKE4"
    when
        $ps: PlayerState(strategy == Strategy.NO_STRATEGY, results.EHS >= make4Threshold)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setStrategy(Strategy.MAKE4)
        }
end

rule "Strategy MAKE2"
    when
        $ps: PlayerState(strategy == Strategy.NO_STRATEGY, results.EHS >= make2Threshold)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setStrategy(Strategy.MAKE2)
        }
end

rule "Determine action - strategy MAKE4 - scenario 1"
    when
        $ps: PlayerState(strategy == Strategy.MAKE4, gameInfo.getBetsToCall() < 2)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.raiseAction(gameInfo))
        }
end

rule "Determine action - strategy MAKE4 - scenario 2"
    when
        $ps: PlayerState(strategy == Strategy.MAKE4, gameInfo.getBetsToCall() >= 2)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.callAction(gameInfo))
        }
end

rule "Determine action - strategy MAKE2 - scenario 1"
    when
        $ps: PlayerState(strategy == Strategy.MAKE2, gameInfo.getBetsToCall() == 0)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.betAction(gameInfo))
        }
end

rule "Determine action - strategy MAKE2 - scenario 2"
    when
        $ps: PlayerState(strategy == Strategy.MAKE2, actionToTake == null, gameInfo.getBetsToCall() == 2)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.betAction(gameInfo))
        }
end

rule "Determine action - strategy MAKE2 - scenario 3"
    when
        $ps: PlayerState(strategy == Strategy.MAKE2, actionToTake == null)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.callAction(gameInfo))
        }
end

/************** SEMI-BLUFFING **************/
rule "Pot odds for semi-bluffing calculation"
    when
        $ps: PlayerState(actionToTake == null, gameInfo.getBetsToCall() == 0, $ourSeat: seat)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        drools.getKnowledgeRuntime().setGlobal("potOdds2", 2 * gameInfo.getCurrentBetSize() / (gameInfo
                                                    .getEligiblePot($ourSeat) + 6 * gameInfo.getCurrentBetSize()));
end

rule "Semi-Bluffing"
    when
        $ps: PlayerState(actionToTake == null, (semiBluffingFlag == true ||
                                (gameInfo.getStage() != Holdem.RIVER && results.PPot >= potOdds2)))
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.betAction(gameInfo))
        }
end

rule "Alternative for semi-bluffing try"
    when
        $ps: PlayerState(actionToTake == null, gameInfo.getBetsToCall() == 0)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.checkAction(gameInfo))
        }
end

/************** Calling With Pot Odds **************/
rule "Pot odds calculation"
    when
        $ps: PlayerState(actionToTake == null, $ourSeat: seat)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        drools.getKnowledgeRuntime().setGlobal("potOdds", gameInfo.getAmountToCall($ourSeat) / (gameInfo
                                        .getEligiblePot($ourSeat) + gameInfo.getAmountToCall($ourSeat)));
end

rule "Calling with pot odds - scenario 1"
    when
        $ps: PlayerState(actionToTake == null, results.EHS >= potOdds, gameInfo.getStage() == Holdem.RIVER)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.callAction(gameInfo))
        }
end

rule "Calling with pot odds - scenario 2"
    when
        $ps: PlayerState(actionToTake == null, results.PPot >= potOdds, gameInfo.getStage() != Holdem.RIVER)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.callAction(gameInfo))
        }
end

/************** Calling With Showdown Odds **************/
rule "Fold river with showdown odds"
    when
        $ps: PlayerState(actionToTake == null, gameInfo.getStage() == Holdem.RIVER)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.foldAction(gameInfo))
        }
end

rule "Calculate showdown cost"
    when
        $ps: PlayerState(actionToTake == null, $ourSeat: seat)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        drools.getKnowledgeRuntime().setGlobal("showdownCost", gameInfo.getStage() == Holdem.FLOP ?
                                                    gameInfo.getCurrentBetSize() * 4 : gameInfo.getCurrentBetSize());
end

rule "Calculate showdown odds"
    when
        $ps: PlayerState(actionToTake == null, $ourSeat: seat, gameInfo.getStage() != Holdem.FLOP)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        drools.getKnowledgeRuntime().setGlobal("showdownOdds", (gameInfo.getAmountToCall($ourSeat) + showdownCost) /
                                                               (gameInfo.getEligiblePot($ourSeat) +
                                                                gameInfo.getAmountToCall($ourSeat) + 2 * showdownCost));
end

rule "Calling with showdown odds"
    when
        $ps: PlayerState(actionToTake == null, results.EHS >= showdownOdds)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.callAction(gameInfo))
        }
end

rule "Fold"
    when
        $ps: PlayerState(actionToTake == null)
    then
        System.out.println("Rule: " + drools.getRule().getName());
        modify($ps) {
            setActionToTake(Action.checkOrFoldAction(gameInfo))
        }
end
